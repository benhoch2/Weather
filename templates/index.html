<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Radar Prediction Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
        }

        .control-button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-button {
            background: #4CAF50;
            color: white;
        }

        .start-button:hover:not(:disabled) {
            background: #45a049;
        }

        .stop-button {
            background: #f44336;
            color: white;
        }

        .stop-button:hover:not(:disabled) {
            background: #da190b;
        }

        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-running {
            background: #4CAF50;
        }

        .status-stopped {
            background: #999;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
        }

        .prediction-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .prediction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }

        .prediction-image {
            width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
        }

        .prediction-info {
            padding: 20px;
        }

        .prediction-time {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .metric {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
        }

        .metric-label {
            font-size: 0.8em;
            color: #666;
            text-transform: uppercase;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.5em;
        }

        .no-predictions {
            background: white;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .no-predictions h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .no-predictions p {
            color: #666;
            font-size: 1.1em;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        /* Modal for full-size image */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
        }

        .close {
            position: absolute;
            top: 30px;
            right: 50px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåßÔ∏è Weather Radar Prediction Viewer</h1>
            <p class="subtitle">Machine Learning Weather Forecasting - Real-time Predictions vs Reality</p>
        </header>

        <!-- Prediction Control Panel -->
        <div class="control-panel">
            <div class="control-buttons">
                <button class="control-button start-button" id="start-btn" onclick="startPredictions()">‚ñ∂ Start Predictions</button>
                <button class="control-button stop-button" id="stop-btn" onclick="stopPredictions()">‚èπ Stop Predictions</button>
            </div>
            <div class="status-indicator">
                <span class="status-dot status-stopped" id="status-dot"></span>
                <span id="status-text">Status: Stopped</span>
            </div>
        </div>

        <div class="statistics" id="statistics">
            <div class="stat-card">
                <div class="stat-value" id="total-predictions">-</div>
                <div class="stat-label">Total Predictions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-mse">-</div>
                <div class="stat-label">Average MSE</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-mae">-</div>
                <div class="stat-label">Average MAE</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-psnr">-</div>
                <div class="stat-label">Average PSNR (dB)</div>
            </div>
        </div>

        <!-- Current Prediction Section -->
        <div id="current-prediction-section" style="display: none;">
            <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 30px;">
                <h2 style="color: #667eea; margin-bottom: 20px;">üîÆ Current Prediction - Next 25 Minutes</h2>
                <div id="current-prediction-content"></div>
            </div>
        </div>

        <h2 style="color: white; margin: 30px 0 20px 0;">üìä Prediction History</h2>
        <div class="predictions-grid" id="predictions-grid">
            <div class="loading">Loading predictions...</div>
        </div>
    </div>

    <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>

    <!-- Modal for full-size image -->
    <div class="modal" id="imageModal" onclick="closeModal()">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
        let currentLimit = 20;
        
        async function loadStatistics() {
            try {
                const response = await fetch('/api/statistics');
                const stats = await response.json();
                
                document.getElementById('total-predictions').textContent = stats.total_predictions || 0;
                document.getElementById('avg-mse').textContent = 
                    stats.avg_mse ? stats.avg_mse.toFixed(6) : 'N/A';
                document.getElementById('avg-mae').textContent = 
                    stats.avg_mae ? stats.avg_mae.toFixed(6) : 'N/A';
                document.getElementById('avg-psnr').textContent = 
                    stats.avg_psnr ? stats.avg_psnr.toFixed(2) : 'N/A';
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        async function loadCurrentPrediction() {
            try {
                const response = await fetch('/api/current_prediction');
                const current = await response.json();
                
                const section = document.getElementById('current-prediction-section');
                const content = document.getElementById('current-prediction-content');
                
                if (current && current.prediction_file) {
                    section.style.display = 'block';
                    
                    const timeInfo = `üìÖ Made ${current.minutes_ago} minute(s) ago`;
                    
                    content.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 30px;">
                            <div style="flex: 0 0 auto;">
                                <img src="/images/${current.prediction_file}" 
                                     style="max-width: 400px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer;"
                                     onclick="openModal('/images/${current.prediction_file}')"
                                     alt="Latest prediction">
                            </div>
                            <div style="flex: 1;">
                                <p style="font-size: 1.2em; color: #333; margin-bottom: 15px;">
                                    <strong>Latest Prediction:</strong> ${current.datetime}
                                </p>
                                <p style="font-size: 1.3em; color: #667eea; font-weight: bold;">
                                    ${timeInfo}
                                </p>
                                <p style="color: #666; margin-top: 15px;">
                                    This animation shows the predicted radar for the next 25 minutes (5 frames).
                                    The model predicts how weather patterns will evolve based on the last hour of data.
                                </p>
                                <p style="color: #999; margin-top: 10px; font-size: 0.9em;">
                                    ‚è≥ Comparison with actual data will appear below in ~${25 - current.minutes_ago} minutes
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    section.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading current prediction:', error);
            }
        }

        async function loadPredictions(append = false) {
            try {
                // Load predictions with current limit
                const response = await fetch(`/api/predictions?limit=${currentLimit}`);
                const predictions = await response.json();
                
                const grid = document.getElementById('predictions-grid');
                
                // Filter to show only completed predictions (with comparisons)
                const completed = predictions.filter(p => p.comparison_file);
                
                if (completed.length === 0 && !append) {
                    grid.innerHTML = `
                        <div class="no-predictions">
                            <h2>No Completed Predictions Yet</h2>
                            <p>Predictions will appear here after evaluation (25 minutes after prediction time).</p>
                        </div>
                    `;
                    return;
                }
                
                if (!append) {
                    grid.innerHTML = '';
                }
                
                // Remove old load more button if it exists
                const oldLoadMore = document.getElementById('load-more-btn');
                if (oldLoadMore) {
                    oldLoadMore.remove();
                }
                
                completed.forEach(pred => {
                    const card = document.createElement('div');
                    card.className = 'prediction-card';
                    
                    // Use comparison animation
                    const imageFile = pred.comparison_file;
                    
                    let metricsHTML = '';
                    if (pred.metrics) {
                        // Check if we have multi-frame metrics
                        if (pred.metrics.average) {
                            metricsHTML = `
                                <div class="metrics">
                                    <div class="metric">
                                        <div class="metric-value">${pred.metrics.average.mse.toFixed(6)}</div>
                                        <div class="metric-label">Avg MSE</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-value">${pred.metrics.average.mae.toFixed(6)}</div>
                                        <div class="metric-label">Avg MAE</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-value">${pred.metrics.average.psnr.toFixed(2)}</div>
                                        <div class="metric-label">Avg PSNR (dB)</div>
                                    </div>
                                </div>
                            `;
                        } else {
                            metricsHTML = `
                                <div class="metrics">
                                    <div class="metric">
                                        <div class="metric-value">${pred.metrics.mse.toFixed(6)}</div>
                                        <div class="metric-label">MSE</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-value">${pred.metrics.mae.toFixed(6)}</div>
                                        <div class="metric-label">MAE</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-value">${pred.metrics.psnr.toFixed(2)}</div>
                                        <div class="metric-label">PSNR (dB)</div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    card.innerHTML = `
                        <img src="/images/${imageFile}" 
                             alt="Prediction comparison" 
                             class="prediction-image"
                             onclick="openModal('/images/${imageFile}')">
                        <div class="prediction-info">
                            <div class="prediction-time">üìÖ ${pred.datetime}</div>
                            <div style="font-size: 0.85em; color: #888; margin-top: 5px;">5-Frame Comparison</div>
                            ${metricsHTML}
                        </div>
                    `;
                    
                    grid.appendChild(card);
                });
                
                // Add "Load More" button if we got the full limit from API (more predictions might exist)
                if (predictions.length === currentLimit) {
                    const loadMoreBtn = document.createElement('div');
                    loadMoreBtn.id = 'load-more-btn';
                    loadMoreBtn.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 20px;';
                    loadMoreBtn.innerHTML = `
                        <button onclick="loadMorePredictions()" style="
                            background: white;
                            color: #667eea;
                            border: 2px solid #667eea;
                            padding: 15px 40px;
                            border-radius: 10px;
                            font-size: 1.1em;
                            cursor: pointer;
                            font-weight: bold;
                            transition: all 0.3s;
                        " onmouseover="this.style.background='#667eea'; this.style.color='white';" 
                           onmouseout="this.style.background='white'; this.style.color='#667eea';">
                            üì¶ Load More Predictions
                        </button>
                        <p style="color: white; margin-top: 10px; font-size: 0.9em;">Currently showing ${completed.length} predictions</p>
                    `;
                    grid.appendChild(loadMoreBtn);
                }
            } catch (error) {
                console.error('Error loading predictions:', error);
                document.getElementById('predictions-grid').innerHTML = `
                    <div class="no-predictions">
                        <h2>Error Loading Predictions</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function loadMorePredictions() {
            currentLimit += 20;  // Load 20 more
            loadPredictions();
        }

        function openModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('active');
            modalImg.src = imageSrc;
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        async function loadData() {
            await loadStatistics();
            await loadCurrentPrediction();
            await loadPredictions();
            await updatePredictionStatus();
        }

        async function updatePredictionStatus() {
            try {
                const response = await fetch('/api/prediction_control/status');
                const data = await response.json();
                
                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                const startBtn = document.getElementById('start-btn');
                const stopBtn = document.getElementById('stop-btn');
                
                if (data.running) {
                    statusDot.className = 'status-dot status-running';
                    statusText.textContent = `Status: Running (PID: ${data.pid})`;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                } else {
                    statusDot.className = 'status-dot status-stopped';
                    statusText.textContent = 'Status: Stopped';
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }

        async function startPredictions() {
            try {
                const response = await fetch('/api/prediction_control/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'started' || data.status === 'already_running') {
                    await updatePredictionStatus();
                    if (data.status === 'started') {
                        alert('Prediction process started successfully!');
                    } else {
                        alert('Prediction process is already running.');
                    }
                } else if (data.status === 'error') {
                    alert('Error starting predictions: ' + data.message);
                }
            } catch (error) {
                console.error('Error starting predictions:', error);
                alert('Failed to start predictions: ' + error.message);
            }
        }

        async function stopPredictions() {
            if (!confirm('Are you sure you want to stop the prediction process?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/prediction_control/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'stopped' || data.status === 'force_stopped' || data.status === 'not_running') {
                    await updatePredictionStatus();
                    if (data.status === 'stopped') {
                        alert('Prediction process stopped successfully.');
                    } else if (data.status === 'force_stopped') {
                        alert('Prediction process was force stopped.');
                    } else {
                        alert('Prediction process was not running.');
                    }
                } else if (data.status === 'error') {
                    alert('Error stopping predictions: ' + data.message);
                }
            } catch (error) {
                console.error('Error stopping predictions:', error);
                alert('Failed to stop predictions: ' + error.message);
            }
        }

        // Load data on page load
        loadData();

        // Auto-refresh data every 30 seconds
        setInterval(loadData, 30000);
        
        // Update prediction status more frequently (every 5 seconds)
        setInterval(updatePredictionStatus, 5000);
    </script>
</body>
</html>
